import { Context } from 'grammy';
import logger from '../utils/logger';

export async function handleStart(ctx: Context) {
  const userId = ctx.from?.id;
  const username = ctx.from?.username || 'User';
  
  logger.info('Start command received', { userId, username });

  const authMode = process.env.AUTH_MODE || 'open';
  
  let authInfo = '';
  if (authMode === 'whitelist') {
    authInfo = '\n\n<i>‚ÑπÔ∏è –î–æ—Å—Ç—É–ø –∫ –ø–æ–ª—É—á–µ–Ω–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.\n–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.</i>';
  } else if (authMode === 'admin_approval') {
    authInfo = '\n\n<i>‚ÑπÔ∏è –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /request_access –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–∞.</i>';
  } else if (authMode === 'closed') {
    authInfo = '\n\n<i>‚ÑπÔ∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.</i>';
  }

  const welcomeMessage = `
üéâ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WireGuard Bot!</b>

–Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é WireGuard VPN.

<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/start - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
/getconfig - –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
/help - –ü–æ–º–æ—â—å –∏ FAQ
${authMode === 'admin_approval' ? '/request_access - –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø' : ''}

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /getconfig${authInfo}
  `.trim();

  await ctx.reply(welcomeMessage, { parse_mode: 'HTML' });
}

export async function handleHelp(ctx: Context) {
  const authMode = process.env.AUTH_MODE || 'open';

  const helpMessage = `
<b>üìñ –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞</b>

<b>–ö–æ–º–∞–Ω–¥—ã:</b>
‚Ä¢ /start - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
‚Ä¢ /getconfig - –°–æ–∑–¥–∞—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é VPN
‚Ä¢ /help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
${authMode === 'admin_approval' ? '‚Ä¢ /request_access - –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª—É—á–µ–Ω–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π' : ''}

<b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:</b>
${authMode === 'admin_approval' ? '1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –∫–æ–º–∞–Ω–¥–æ–π /request_access (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–µ–ª–∞–ª–∏)\n2. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n3. ' : '1. '}–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /getconfig
${authMode === 'admin_approval' ? '4. ' : '2. '}–ë–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –¥–ª—è –≤–∞—Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
${authMode === 'admin_approval' ? '5. ' : '3. '}–í—ã –ø–æ–ª—É—á–∏—Ç–µ:
   - –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (.conf)
   - QR-–∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –û–¥–Ω–æ—Ä–∞–∑–æ–≤—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

<b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard:</b>
‚Ä¢ <b>iOS/Android:</b> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ WireGuard –∏–∑ App Store/Google Play
‚Ä¢ <b>Windows/macOS/Linux:</b> –°–∫–∞—á–∞–π—Ç–µ —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ wireguard.com

<b>–ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:</b>
‚Ä¢ –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
‚Ä¢ –ò–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .conf –≤—Ä—É—á–Ω—É—é

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
  `.trim();

  await ctx.reply(helpMessage, { parse_mode: 'HTML' });
}
